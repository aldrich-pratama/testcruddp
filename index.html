<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>Dashboard Jadwal Visit Pasien</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
        }

        .control-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .control-group input,
        .control-group select {
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            flex: 1;
            min-width: 200px;
            border-left: 4px solid #4f46e5;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #4f46e5;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .table th {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .table th:hover {
            background: linear-gradient(135deg, #4338ca, #6d28d9);
        }

       .table th.sortable::after {
  content: '‚áÖ'; /* Alternatif: '‚Üë‚Üì' atau '‚áµ' */
  margin-left: 8px;
  opacity: 0.7;
  font-family: inherit;
}

        .table th.sort-asc::after {
            content: '‚Üë';
        }

        .table th.sort-desc::after {
            content: '‚Üì';
        }

        .table td {
            padding: 15px 12px;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.3s ease;
        }

        .table tr:hover {
            background: #f8fafc;
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .page-btn:hover,
        .page-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .page-info {
            color: #6b7280;
            margin: 0 15px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .alert {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .table-container {
                padding: 15px;
            }
            
            .table th,
            .table td {
                padding: 10px 8px;
                font-size: 0.9rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Dashboard Jadwal Visit Pasien</h1>
            <p>Kelola jadwal visit pasien dengan mudah dan efisien</p>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>üîç Cari Nama Pasien</label>
                    <input type="text" id="searchNama" placeholder="Masukkan nama pasien...">
                </div>
                <div class="control-group">
                    <label>üé´ Cari Kode Antrian</label>
                    <input type="text" id="searchKode" placeholder="Masukkan kode antrian...">
                </div>
                <div class="control-group">
                    <label>üìÖ Filter Tanggal Visit</label>
                    <input type="date" id="filterTanggal">
                </div>
                                <div class="control-group">
  <label>üë®‚Äç‚öïÔ∏è Cari Nama Terapis</label>
  <input type="text" id="searchTerapis" placeholder="Masukkan nama terapis...">
</div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="searchData()">
                        üîç Cari Data
                    </button>
                </div>

            </div>

            <div class="control-row">
                <button class="btn btn-success" onclick="openModal('add')">
                    ‚ûï Tambah Visit Baru
                </button>
                <button class="btn btn-primary" onclick="loadData()">
                    üîÑ Refresh Data
                </button>
                <button class="btn btn-warning" onclick="clearFilters()">
                    üóëÔ∏è Reset Filter
                </button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalData">0</div>
                    <div class="stat-label">Total Visit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayVisit">0</div>
                    <div class="stat-label">Visit Hari Ini</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="thisWeekVisit">0</div>
                    <div class="stat-label">Visit Minggu Ini</div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Memuat data...</p>
            </div>

            <table class="table" id="dataTable" style="display: none;">
                <thead>
<tr>
  <th class="sortable" data-sort="tanggalPesan">
    <i class="fa-solid fa-calendar-days"></i> Tanggal Pesan
  </th>
  <th class="sortable" data-sort="kodeAntrian">
    <i class="fa-solid fa-ticket"></i> Kode Antrian
  </th>
  <th class="sortable" data-sort="namaPasien">
    <i class="fa-solid fa-user"></i> Nama Pasien
  </th>
  <th>
    <i class="fa-solid fa-hashtag"></i> Jml Visit
  </th>
  <th>
    <i class="fa-solid fa-stethoscope"></i> Layanan
  </th>
  <th>
    <i class="fa-solid fa-location-dot"></i> Wilayah
  </th>
  <th>
    <i class="fa-solid fa-chart-bar"></i> Visit Ke
  </th>
  <th class="sortable" data-sort="tanggalVisit">
    <i class="fa-solid fa-calendar-day"></i> Tanggal Visit
  </th>
  <th>
    <i class="fa-solid fa-clock"></i> Jam Visit
  </th>
  <th>
    <i class="fa-solid fa-user-doctor"></i> Terapis
  </th>
  <th>
    <i class="fa-solid fa-thumbtack"></i> Status Terapis
  </th>
  <th>
    <i class="fa-solid fa-gear"></i> Aksi
  </th>
</tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>

            <div class="pagination" id="pagination"></div>
        </div>
    </div>
<!-- Modal Tambah Visit Baru -->
<div id="modalAddVisit" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="close" onclick="closeModal('modalAddVisit')">&times;</span>
      <h3>‚ûï Tambah Visit Baru</h3>
    </div>
    <div class="modal-body">
      <div id="modalAlertAdd"></div>
      <form id="formAddVisit">
        <div class="form-group">
          <label>üìÖ Tanggal Pemesanan</label>
          <input type="date" id="tanggalPesanAdd" required>
        </div>
        <div class="form-group">
          <label>üé´ Kode Antrian</label>
          <input type="text" id="kodeAntrianAdd" required placeholder="Contoh: KA001">
        </div>
        <div class="form-group">
          <label>üë§ Nama Pasien</label>
          <input type="text" id="namaPasienAdd" required placeholder="Nama lengkap pasien">
        </div>
        <div class="form-group">
          <label>üî¢ Jumlah Visit</label>
          <input type="number" id="jumlahVisitAdd" required min="1" placeholder="Jumlah visit">
        </div>
        <div class="form-group">
          <label>üè• Layanan</label>
          <select id="layananAdd" required>
            <option value="">Pilih Layanan</option>
            <option value="Fisioterapi">Fisioterapi</option>
            <option value="Terapi Wicara">Terapi Wicara</option>
            <option value="Terapi Okupasi">Terapi Okupasi</option>
          </select>
        </div>
        <div class="form-group">
          <label>üìç Wilayah</label>
          <select id="wilayahAdd" required>
            <option value="">Pilih Wilayah</option>
            <option value="Jakarta Pusat">Jakarta Pusat</option>
            <option value="Jakarta Utara">Jakarta Utara</option>
            <option value="Jakarta Selatan">Jakarta Selatan</option>
            <option value="Jakarta Timur">Jakarta Timur</option>
            <option value="Jakarta Barat">Jakarta Barat</option>
            <option value="Bogor">Bogor</option>
            <option value="Depok">Depok</option>
            <option value="Tangerang">Tangerang</option>
            <option value="Bekasi">Bekasi</option>
          </select>
        </div>
        <div style="text-align: right; margin-top: 30px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('modalAddVisit')" style="margin-right: 10px;">Batal</button>
          <button type="submit" class="btn btn-success">üíæ Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>
    <!-- Modal Form -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal()">&times;</span>
                <h3 id="modalTitle">Tambah Visit Baru</h3>
            </div>
            <div class="modal-body">
                <div id="modalAlert"></div>
                <form id="dataForm">
                    <div class="form-group">
                        <label>üìÖ Tanggal Pemesanan</label>
                        <input type="date" id="tanggalPesan" required>
                    </div>
                    <div class="form-group">
                        <label>üé´ Kode Antrian</label>
                        <input type="text" id="kodeAntrian" required placeholder="Contoh: KA001">
                    </div>
                    <div class="form-group">
                        <label>üë§ Nama Pasien</label>
                        <input type="text" id="namaPasien" required placeholder="Nama lengkap pasien">
                    </div>
                    <div class="form-group">
                        <label>üî¢ Jumlah Visit</label>
                        <input type="number" id="jumlahVisit" required min="1" placeholder="Jumlah visit">
                    </div>
                    <div class="form-group">
                        <label>üè• Layanan</label>
                        <select id="layanan" required>
                            <option value="">Pilih Layanan</option>
                            <option value="Fisioterapi">Fisioterapi</option>
                            <option value="Terapi Wicara">Terapi Wicara</option>
                            <option value="Terapi Okupasi">Terapi Okupasi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìç Wilayah</label>
                        <select id="wilayah" required>
                            <option value="">Pilih Wilayah</option>
                            <option value="Jakarta Pusat">Jakarta Pusat</option>
                            <option value="Jakarta Utara">Jakarta Utara</option>
                            <option value="Jakarta Selatan">Jakarta Selatan</option>
                            <option value="Jakarta Timur">Jakarta Timur</option>
                            <option value="Jakarta Barat">Jakarta Barat</option>
                            <option value="Bogor">Bogor</option>
                            <option value="Depok">Depok</option>
                            <option value="Tangerang">Tangerang</option>
                            <option value="Bekasi">Bekasi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìä Visit Ke</label>
                        <input type="number" id="visitKe" required min="1" placeholder="Visit ke berapa">
                    </div>
                    <div class="form-group">
                        <label>üìÖ Tanggal Visit</label>
                        <input type="date" id="tanggalVisit" required>
                    </div>
                    <div class="form-group">
                        <label>‚è∞ Jam Visit</label>
                        <input type="time" id="jamVisit" required>
                    </div>
                    <div class="form-group">
                        <label>üë®‚Äç‚öïÔ∏è Nama Terapis</label>
                        <select id="namaTerapis" required>
  <option value="">Pilih Terapis</option>
</select>
                    </div>
                    <div style="text-align: right; margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" style="margin-right: 10px;">Batal</button>
                        <button type="submit" class="btn btn-success">üíæ Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi Global
        const CONFIG = {
            ROWS_PER_PAGE: 50,
            CACHE_DURATION: 5 * 60 * 1000, // 5 menit
            DEBOUNCE_DELAY: 500
        };

        // State Management
        let currentData = [];
        let filteredData = [];
        let currentPage = 1;
        let sortColumn = '';
        let sortDirection = 'asc';
        let editingRowIndex = -1;
        let cache = {
            data: null,
            timestamp: 0
        };

        // Debounce function untuk optimasi pencarian
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Load data dari cache atau server
function loadData() {
    const now = Date.now();

    if (cache.data && (now - cache.timestamp < CONFIG.CACHE_DURATION)) {
        currentData = cache.data;
        filteredData = [...currentData];
        displayData();
        updateStats();
        return;
    }

    showLoading(true);

fetch('https://script.google.com/macros/s/AKfycbXXXXX/exec?action=getData')
  .then(res => res.json())
  .then(data => {
    currentData = data;
    cache.data = data;
    cache.timestamp = Date.now();
    filteredData = [...currentData];
    displayData();
    updateStats();
    showLoading(false);
  })
  .catch(error => {
    console.error('Gagal memuat data:', error);
    showAlert('Gagal memuat data dari server!', 'error');
    showLoading(false);
  });

        // Generate dummy data untuk demo
        function generateDummyData() {
            const layananList = ['Fisioterapi', 'Terapi Wicara', 'Terapi Okupasi'];
            const wilayahList = ['Jakarta Pusat', 'Jakarta Utara', 'Jakarta Selatan', 'Jakarta Timur', 'Jakarta Barat', 'Bogor', 'Depok', 'Tangerang', 'Bekasi'];
            const terapisList = ['Adi Krismawan', 'Albertus Bryan', 'Mesi Purnama Sari'];
            const data = [];

            for (let i = 1; i <= 100; i++) {
               // Menghasilkan tanggal pesan hanya di bulan Juni 2025
               const tanggalPesan = new Date(2025, 5, Math.floor(Math.random() * 30) + 1); // Bulan Juni = 5, dan tanggal antara 1 dan 30
                // Menghasilkan tanggal visit, rentang waktu 1 hingga 30 hari setelah tanggal pesan
              const tanggalVisit = new Date(tanggalPesan.getTime() + Math.random() * 30 * 24 * 60 * 60 * 1000);
                
                data.push({
                    tanggalPesan: tanggalPesan.toISOString().split('T')[0],
                    kodeAntrian: `KA${String(i).padStart(3, '0')}`,
                    namaPasien: `Pasien ${i}`,
                    jumlahVisit: Math.floor(Math.random() * 10) + 1,
                    layanan: layananList[Math.floor(Math.random() * layananList.length)],
                    wilayah: wilayahList[Math.floor(Math.random() * wilayahList.length)],
                    visitKe: Math.floor(Math.random() * 5) + 1,
                    tanggalVisit: tanggalVisit.toISOString().split('T')[0],
                    jamVisit: `${String(Math.floor(Math.random() * 12) + 8).padStart(2, '0')}:${['00', '30'][Math.floor(Math.random() * 2)]}`,
                    namaTerapis: terapisList[Math.floor(Math.random() * terapisList.length)]
                });
            }
            return data;
        }

        // Pencarian data dengan debounce
        const debouncedSearch = debounce(searchData, CONFIG.DEBOUNCE_DELAY);

function searchData() {
    const searchNama = document.getElementById('searchNama').value.toLowerCase();
    const searchKode = document.getElementById('searchKode').value.toLowerCase();
    const searchTerapis = document.getElementById('searchTerapis').value.toLowerCase();
    const filterTanggal = document.getElementById('filterTanggal').value;

    filteredData = currentData.filter(row => {
        const matchNama = !searchNama || row.namaPasien.toLowerCase().includes(searchNama);
        const matchKode = !searchKode || row.kodeAntrian.toLowerCase().includes(searchKode);
        const matchTerapis = !searchTerapis || row.namaTerapis.toLowerCase().includes(searchTerapis);
        const matchTanggal = !filterTanggal || row.tanggalVisit === filterTanggal;
        
        return matchNama && matchKode && matchTerapis && matchTanggal;
    });

    currentPage = 1;
    displayData();
    updateStats();
}

        // Clear filters
        function clearFilters() {
            document.getElementById('searchNama').value = '';
            document.getElementById('searchKode').value = '';
            document.getElementById('filterTanggal').value = '';
            document.getElementById('searchTerapis').value = '';
            
            filteredData = [...currentData];
            currentPage = 1;
            displayData();
            updateStats();
        }

        // Sorting data
        function sortData(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            filteredData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (column.includes('tanggal')) {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            updateSortUI();
            displayData();
        }

        // Update UI sorting
        function updateSortUI() {
            document.querySelectorAll('.table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            const currentTh = document.querySelector(`[data-sort="${sortColumn}"]`);
            if (currentTh) {
                currentTh.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }

        // Display data dengan pagination
        function displayData() {
            const startIndex = (currentPage - 1) * CONFIG.ROWS_PER_PAGE;
            const endIndex = startIndex + CONFIG.ROWS_PER_PAGE;
            const pageData = filteredData.slice(startIndex, endIndex);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            pageData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(row.tanggalPesan)}</td>
                    <td><span style="background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 6px; font-weight: 600;">${row.kodeAntrian}</span></td>
                    <td><strong>${row.namaPasien}</strong></td>
                    <td><span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 6px;">${row.jumlahVisit}</span></td>
                    <td>${row.layanan}</td>
                    <td>${row.wilayah}</td>
                    <td><span style="background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 6px;">${row.visitKe}</span></td>
                    <td><strong>${formatDate(row.tanggalVisit)}</strong></td>
                    <td>${row.jamVisit}</td>
                    <td>${row.namaTerapis}</td>
                    <td>${row.statusTerapis || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editData(${startIndex + index})" title="Edit">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteData(${startIndex + index})" title="Hapus">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            updatePagination();
            document.getElementById('dataTable').style.display = 'table';
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / CONFIG.ROWS_PER_PAGE);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            if (currentPage > 1) {
                const prevBtn = createPageButton('¬´ Prev', currentPage - 1);
                pagination.appendChild(prevBtn);
            }

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                pagination.appendChild(createPageButton('1', 1));
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px';
                    pagination.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = createPageButton(i, i);
                if (i === currentPage) {
                    pageBtn.classList.add('active');
                }
                pagination.appendChild(pageBtn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px';
                    pagination.appendChild(ellipsis);
                }
                pagination.appendChild(createPageButton(totalPages, totalPages));
            }

            // Next button
            if (currentPage < totalPages) {
                const nextBtn = createPageButton('Next ¬ª', currentPage + 1);
                pagination.appendChild(nextBtn);
            }

            // Page info
            const pageInfo = document.createElement('span');
            pageInfo.className = 'page-info';
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages} (${filteredData.length} data)`;
            pagination.appendChild(pageInfo);
        }

        // Create page button
        function createPageButton(text, page) {
            const btn = document.createElement('button');
            btn.className = 'page-btn';
            btn.textContent = text;
            btn.onclick = () => goToPage(page);
            return btn;
        }

        // Go to page
        function goToPage(page) {
            currentPage = page;
            displayData();
        }

        // Update statistics
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekStartStr = weekStart.toISOString().split('T')[0];

            const todayVisits = filteredData.filter(row => row.tanggalVisit === today).length;
            const weekVisits = filteredData.filter(row => row.tanggalVisit >= weekStartStr).length;

            document.getElementById('totalData').textContent = filteredData.length;
            document.getElementById('todayVisit').textContent = todayVisits;
            document.getElementById('thisWeekVisit').textContent = weekVisits;
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('dataTable').style.display = show ? 'none' : 'table';
        }

        // Format date
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                timeZone: 'Asia/Jakarta'
            };
            return date.toLocaleDateString('id-ID', options);
        }

        // Modal functions
function openModal(mode, index = -1) {
    editingRowIndex = index;
    const modal = document.getElementById('dataModal');
    const modalTitle = document.getElementById('modalTitle');
    const form = document.getElementById('dataForm');
    
    form.reset();
    document.getElementById('modalAlert').innerHTML = '';

    if (mode === 'add') {
        // Tambah Visit Baru
        modalTitle.textContent = '‚ûï Tambah Visit Baru';

        // Set default date to today
        document.getElementById('tanggalPesan').value = new Date().toISOString().split('T')[0];

        // Tidak ada read-only, input dapat diedit
        document.getElementById('tanggalPesan').removeAttribute('readonly');
        document.getElementById('kodeAntrian').removeAttribute('readonly');
        document.getElementById('visitKe').removeAttribute('readonly');
    } else if (mode === 'edit' && index >= 0) {
        // Edit Visit
        modalTitle.textContent = '‚úèÔ∏è Edit Data Visit';
        const data = filteredData[index];
        
        // Fill form with existing data
        document.getElementById('tanggalPesan').value = data.tanggalPesan;
        document.getElementById('kodeAntrian').value = data.kodeAntrian;
        document.getElementById('namaPasien').value = data.namaPasien;
        document.getElementById('jumlahVisit').value = data.jumlahVisit;
        document.getElementById('layanan').value = data.layanan;
        document.getElementById('wilayah').value = data.wilayah;
        document.getElementById('visitKe').value = data.visitKe;
        document.getElementById('tanggalVisit').value = data.tanggalVisit;
        document.getElementById('jamVisit').value = data.jamVisit;
        document.getElementById('namaTerapis').value = data.namaTerapis;

        // Set read-only for specific fields in edit mode
        document.getElementById('tanggalPesan').setAttribute('readonly', 'true');
        document.getElementById('kodeAntrian').setAttribute('readonly', 'true');
        document.getElementById('visitKe').setAttribute('readonly', 'true');
    }

    modal.style.display = 'block';
}

        function closeModal() {
            document.getElementById('dataModal').style.display = 'none';
            editingRowIndex = -1;
        }

        // Edit data
        function editData(index) {
            openModal('edit', index);
        }

        // Delete data
        async function deleteData(index) {
            if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;

            try {
                const data = filteredData[index];
                
                // Simulasi API call untuk delete
fetch('https://script.google.com/macros/s/AKfycbxHOUX_yoOIt5T5DUBamhOewZVBv5cUH4YldmLRPoIwbKFoj8s3QE2Yr4N9syyXWfuq8A/exec?action=remove', {
  method: 'POST',
  body: JSON.stringify({ kodeAntrian: data.kodeAntrian }),
  headers: {
    'Content-Type': 'application/json'
  }
})
.then(res => res.json())
.then(() => {
  alert('Data berhasil dihapus');
  loadData();
})
.catch(err => {
  console.error(err);
  alert('Gagal menghapus data');
});


        // Form submission
        document.getElementById('dataForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                tanggalPesan: document.getElementById('tanggalPesan').value,
                kodeAntrian: document.getElementById('kodeAntrian').value,
                namaPasien: document.getElementById('namaPasien').value,
                jumlahVisit: parseInt(document.getElementById('jumlahVisit').value),
                layanan: document.getElementById('layanan').value,
                wilayah: document.getElementById('wilayah').value,
                visitKe: parseInt(document.getElementById('visitKe').value),
                tanggalVisit: document.getElementById('tanggalVisit').value,
                jamVisit: document.getElementById('jamVisit').value,
                namaTerapis: document.getElementById('namaTerapis').value
            };

            // Validate dates
            if (new Date(formData.tanggalVisit) < new Date(formData.tanggalPesan)) {
                showAlert('Tanggal visit tidak boleh lebih awal dari tanggal pemesanan!', 'error');
                return;
            }

            // Check duplicate kode antrian (except when editing)
            const isDuplicate = currentData.some((item, index) => 
                item.kodeAntrian === formData.kodeAntrian && 
                (editingRowIndex === -1 || index !== editingRowIndex)
            );

            if (isDuplicate) {
                showAlert('Kode antrian sudah digunakan!', 'error');
                return;
            }

            try {
                if (editingRowIndex >= 0) {
                    // Update existing data
                    const originalIndex = currentData.findIndex(item => 
                        item.kodeAntrian === filteredData[editingRowIndex].kodeAntrian
                    );
                    
                    if (originalIndex > -1) {
                        currentData[originalIndex] = formData;
                    }
                    filteredData[editingRowIndex] = formData;
                    
                    showAlert('Data berhasil diupdate!', 'success');
                } else {
                    // Add new data
                    currentData.push(formData);
                    filteredData.push(formData);
                    
                    showAlert('Data berhasil ditambahkan!', 'success');
                }

                // Update cache
                cache.data = currentData;
                cache.timestamp = Date.now();

                // Simulasi API call
if (editingRowIndex >= 0) {
fetch('https://script.google.com/macros/s/AKfycbxHOUX_yoOIt5T5DUBamhOewZVBv5cUH4YldmLRPoIwbKFoj8s3QE2Yr4N9syyXWfuq8A/exec?action=update', {
  method: 'POST',
  body: JSON.stringify(formData),
  headers: {
    'Content-Type': 'application/json'
  }
})
.then(res => res.json())
.then(() => {
  alert('Data berhasil diupdate');
  loadData();
})
.catch(err => {
  console.error(err);
  alert('Gagal mengupdate data');
});

    .update(formData); // memanggil fungsi update di Code.gs
} else {
fetch('https://script.google.com/macros/s/AKfycbxHOUX_yoOIt5T5DUBamhOewZVBv5cUH4YldmLRPoIwbKFoj8s3QE2Yr4N9syyXWfuq8A/exec?action=create', {
  method: 'POST',
  body: JSON.stringify(formData),
  headers: {
    'Content-Type': 'application/json'
  }
})
.then(res => res.json())
.then(() => {
  alert('Data berhasil ditambahkan');
  loadData();
})
.catch(err => {
  console.error(err);
  alert('Gagal menambahkan data');
});
    .create(formData); // memanggil fungsi create di Code.gs
}

                displayData();
                updateStats();
                
                setTimeout(() => {
                    closeModal();
                }, 1500);

            } catch (error) {
                console.error('Error saving data:', error);
                showAlert('Error menyimpan data: ' + error.message, 'error');
            }
        });

        // Show alert in modal
        function showAlert(message, type) {
            const alertDiv = document.getElementById('modalAlert');
            alertDiv.innerHTML = `
                <div class="alert alert-${type === 'error' ? 'error' : 'success'}">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadTerapisDropdown();
            
            // Search event listeners dengan debounce
            document.getElementById('searchNama').addEventListener('input', debouncedSearch);
            document.getElementById('searchKode').addEventListener('input', debouncedSearch);
            document.getElementById('filterTanggal').addEventListener('change', searchData);
            document.getElementById('searchTerapis').addEventListener('input', debouncedSearch);
            
            // Sort event listeners
            document.querySelectorAll('.table th.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const sortKey = this.dataset.sort;
                    sortData(sortKey);
                });
            });

            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('dataModal');
                if (event.target === modal) {
                    closeModal();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchNama').focus();
                }
            });
        });

        // Auto-generate kode antrian
        function generateKodeAntrian() {
            const lastKode = currentData
                .map(item => item.kodeAntrian)
                .filter(kode => kode.startsWith('KA'))
                .map(kode => parseInt(kode.replace('KA', '')))
                .sort((a, b) => b - a)[0] || 0;
            
            return `KA${String(lastKode + 1).padStart(3, '0')}`;
        }

        // Helper function for better UX
        document.getElementById('kodeAntrian').addEventListener('focus', function() {
            if (!this.value && editingRowIndex === -1) {
                this.value = generateKodeAntrian();
            }
        });

        // Responsive table scroll
        function handleTableScroll() {
            const tableContainer = document.querySelector('.table-container');
            const table = document.querySelector('.table');
            
            if (table.scrollWidth > tableContainer.clientWidth) {
                tableContainer.style.overflowX = 'auto';
            }
        }

        // Initialize
        window.addEventListener('resize', handleTableScroll);
        setTimeout(handleTableScroll, 100);

       // List Nama Terapis di Modal Dropdown
        function loadTerapisDropdown() {
fetch('https://script.google.com/macros/s/AKfycbxHOUX_yoOIt5T5DUBamhOewZVBv5cUH4YldmLRPoIwbKFoj8s3QE2Yr4N9syyXWfuq8A/exec?action=getTerapis')
  .then(res => res.json())
  .then(data => {
    const select = document.getElementById('namaTerapis');
    data.forEach(nama => {
      const option = document.createElement('option');
      option.value = nama;
      option.textContent = nama;
      select.appendChild(option);
    });
  });

    </script>
</body>
</html>
